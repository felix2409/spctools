<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>IMG → PDF (All Formats)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Decoder TIFF & HEIC -->
  <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Roboto,system-ui,-apple-system,Arial; background:#eef2f7; color:#222; padding:2rem;}
    h2{color:#1e3a8a;margin-bottom:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:0.8rem;align-items:center}
    input[type=file]{padding:1rem;border:2px dashed #cbd5e1;border-radius:10px;background:#fff}
    select,input[type=number]{padding:0.7rem;border-radius:8px;border:1px solid #d1d5db}
    label{font-size:0.95rem}
    .status{margin-top:1.2rem;max-height:46vh;overflow:auto;background:#fff;padding:1rem;border-radius:10px;box-shadow:0 6px 18px rgba(30,58,138,0.06)}
    .status ul{list-style:none;padding:0;margin:0}
    .status li{padding:0.4rem 0;border-bottom:1px dashed #eee;font-size:0.95rem}
    .status .ok{color:#16a34a}
    .status .warn{color:#ca8a04}
    .status .err{color:#dc2626}
    .form-row{display:flex;gap:0.6rem;align-items:center}
    .panel{display:flex;flex-direction:column;gap:0.6rem}
    .small{font-size:0.85rem;color:#475569}
    .action-bar{position:sticky;bottom:0;left:0;right:0;background:#fff;padding:0.8rem;border-top:1px solid #e6eef9;box-shadow:0 -6px 18px rgba(30,58,138,0.04);display:flex;justify-content:space-between;align-items:center;margin-top:1rem}
    .action-bar .left{display:flex;gap:0.6rem}
    button{padding:0.7rem 1rem;border-radius:10px;border:none;background:#1e3a8a;color:#fff;font-weight:600;cursor:pointer}
    .btn-ghost{background:#fff;color:#1e3a8a;border:1px solid #cfe0ff}
    .meta{font-size:0.9rem;color:#334155}
    @media(max-width:720px){.controls{flex-direction:column}.form-row{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <h2><i class="fa-solid fa-images"></i> IMG → PDF</h2>

  <div class="controls">
    <label>
      <!-- Terima banyak format termasuk TIFF & HEIC -->
      <input id="upload" type="file"
        accept=".jpg,.jpeg,.png,.webp,.gif,.bmp,.tif,.tiff,.heic,.heif,.svg,image/*"
        multiple style="display:none">
      <div id="dropArea" style="padding:1rem 1.2rem;border-radius:10px;background:#fff;border:2px dashed #cbd5e1;cursor:pointer;min-width:260px;text-align:left">
        <div><strong>Pilih / Taruh gambar</strong></div>
        <div class="small">Klik untuk pilih banyak gambar</div>
      </div>
    </label>

    <div class="panel">
      <div class="small">Ukuran halaman (mm)</div>
      <select id="ukuran" onchange="toggleCustomSize(this.value)">
        <option value="420x297">A3</option>
        <option value="297x210" selected>A4</option>
        <option value="210x148.5">A5</option>
        <option value="470x310">47×31 cm</option>
        <option value="480x320">48×32 cm</option>
        <option value="custom">Custom</option>
      </select>
    </div>

    <div class="panel" id="customSizeInputs" style="display:none;min-width:220px">
      <div class="form-row">
        <input id="customWidth" type="number" step="0.01" placeholder="Panjang (mm)" style="width:120px">
        <input id="customHeight" type="number" step="0.01" placeholder="Tinggi (mm)" style="width:120px">
      </div>
    </div>

    <div class="panel">
      <div class="small">Orientasi</div>
      <select id="orientasi">
        <option value="portrait" selected>POTRAIT</option>
        <option value="landscape">LANDSCAPE</option>
      </select>
    </div>

    <div class="panel">
      <div class="small">Mode Gabung</div>
      <select id="modeGabung">
        <option value="gabung" selected>Gabung (1 PDF)</option>
        <option value="pisah">Pisah (per gambar)</option>
      </select>
    </div>

    <div class="panel">
      <div class="small">Mode Scale</div>
      <select id="scaleMode">
        <option value="fill" selected>Fill</option>
        <option value="fit">Fit</option>
        <option value="stretch">Stretch</option>
      </select>
    </div>
  </div>

  <div class="status" id="statusBox">
    <ul id="statusList"></ul>
  </div>

  <div class="action-bar">
    <div class="left">
      <button id="resetBtn" class="btn-ghost">Reset</button>
    </div>
    <div style="display:flex;gap:0.6rem">
      <button id="convertBtn">Ubah & Unduh PDF</button>
    </div>
  </div>

  <canvas id="canvas" style="display:none"></canvas>

  <script>
    const { jsPDF } = window.jspdf;
    const upload = document.getElementById('upload');
    const dropArea = document.getElementById('dropArea');
    const statusList = document.getElementById('statusList');
    const convertBtn = document.getElementById('convertBtn');
    const resetBtn = document.getElementById('resetBtn');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function updateStatus(text, type='ok'){
      const li = document.createElement('li');
      const cls = type==='ok' ? 'ok' : type==='warn' ? 'warn' : 'err';
      const icon = type==='ok' ? '✓' : type==='warn' ? '!' : '✖';
      li.innerHTML = `<span class="${cls}">${icon}</span> ${text}`;
      statusList.appendChild(li);
    }

    function toggleCustomSize(value){
      document.getElementById('customSizeInputs').style.display = value==='custom' ? 'block' : 'none';
    }

    function clearAll(){
      upload.value = '';
      statusList.innerHTML = '';
      document.getElementById('ukuran').value = '297x210';
      document.getElementById('orientasi').value = 'portrait';
      document.getElementById('modeGabung').value = 'gabung';
      document.getElementById('scaleMode').value = 'fill';
    }

    resetBtn.addEventListener('click',()=>{
      clearAll();
      updateStatus('Form di-reset (input & log dibersihkan)','ok');
    });

    // Tidak perlu addEventListener('click', ()=>upload.click()) karena <label> sudah memicu otomatis
    dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.style.borderColor='#94a3b8'});
    dropArea.addEventListener('dragleave',e=>{e.preventDefault();dropArea.style.borderColor='#cbd5e1'});
    dropArea.addEventListener('drop',e=>{
      e.preventDefault();
      dropArea.style.borderColor='#cbd5e1';
      if(e.dataTransfer.files.length) upload.files = e.dataTransfer.files;
    });

    // --- Helpers umum ---
    function readAsDataURL(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    function readAsArrayBuffer(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsArrayBuffer(blob);
      });
    }

    function drawToCanvasFromImage(img){
      canvas.width = img.width;
      canvas.height = img.height;
      // latar putih agar PDF tidak transparan
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0);
      return canvas.toDataURL('image/jpeg', 1.0);
    }

    // --- Decoder spesifik format ---
    async function decodeTIFF(file){
      if (typeof UTIF === 'undefined' || !UTIF.decode) {
        throw new Error('UTIF.js tidak tersedia');
      }
      const buf = await readAsArrayBuffer(file);
      const ifds = UTIF.decode(buf);
      if (!ifds || !ifds.length) throw new Error('Tidak ada halaman TIFF.');
      UTIF.decodeImage(buf, ifds[0]);               // decode halaman pertama
      const rgba = UTIF.toRGBA8(ifds[0]);           // Uint8Array RGBA
      const w = ifds[0].width, h = ifds[0].height;
      canvas.width = w; canvas.height = h;
      const imgData = new ImageData(new Uint8ClampedArray(rgba), w, h);
      ctx.putImageData(imgData, 0, 0);
      // latar putih (TIFF bisa transparan/bitmap)
      const whiteBG = document.createElement('canvas');
      whiteBG.width = w; whiteBG.height = h;
      const wctx = whiteBG.getContext('2d');
      wctx.fillStyle = '#fff';
      wctx.fillRect(0,0,w,h);
      wctx.drawImage(canvas,0,0);
      return whiteBG.toDataURL('image/jpeg', 1.0);
    }

    async function decodeHEIC(file){
      if (typeof heic2any === 'undefined') {
        throw new Error('heic2any tidak tersedia');
      }
      // konversi ke JPEG (Blob), lalu ke dataURL
      const jpegBlob = await heic2any({ blob: file, toType: 'image/jpeg', quality: 1 });
      return await readAsDataURL(jpegBlob);
    }

    // Fallback umum untuk format yang didukung <img> langsung
    async function decodeWithImageElement(file){
      const dataURL = await readAsDataURL(file);
      const img = new Image();
      // agar aman di beberapa browser saat load dataURL SVG
      img.decoding = 'async';
      return new Promise((resolve, reject)=>{
        img.onload = ()=> resolve(drawToCanvasFromImage(img));
        img.onerror = ()=> reject(new Error('Gagal memuat gambar'));
        img.src = dataURL;
      });
    }

    async function getImageDataUniversal(file){
      const type = (file.type || '').toLowerCase();
      const name = (file.name || '').toLowerCase();

      try{
        // HEIC/HEIF
        if (type.includes('heic') || type.includes('heif') || name.endsWith('.heic') || name.endsWith('.heif')){
          updateStatus(`Konversi HEIC → JPEG: ${file.name}`, 'warn');
          return await decodeHEIC(file);
        }
        // TIFF
        if (type.includes('tiff') || name.endsWith('.tif') || name.endsWith('.tiff')){
          updateStatus(`Decode TIFF: ${file.name}`, 'warn');
          return await decodeTIFF(file);
        }
        // Lainnya (JPG/PNG/WebP/BMP/GIF/SVG) via <img>
        return await decodeWithImageElement(file);
      }catch(err){
        // Coba fallback terakhir: paksa via <img>
        try{
          updateStatus(`Fallback standar untuk ${file.name}`, 'warn');
          return await decodeWithImageElement(file);
        }catch(e2){
          throw err;
        }
      }
    }

    convertBtn.addEventListener('click', async ()=>{
      statusList.innerHTML = '';
      const files = upload.files;
      if(!files.length){updateStatus('Belum ada gambar dipilih','err');return;}

      // --- ukuran halaman ---
      let width,height;
      const ukuran = document.getElementById('ukuran').value;
      const orientasi = document.getElementById('orientasi').value;
      if(ukuran==='custom'){
        width = parseFloat(document.getElementById('customWidth').value);
        height = parseFloat(document.getElementById('customHeight').value);
        if(!width||!height){updateStatus('Isi ukuran custom dengan benar','err');return;}
      }else{
        const [w,h] = ukuran.split('x').map(Number);
        width = orientasi==='portrait'?Math.min(w,h):Math.max(w,h);
        height = orientasi==='portrait'?Math.max(w,h):Math.min(w,h);
      }

      let gabungPDF=null;
      if(document.getElementById('modeGabung').value==='gabung'){
        gabungPDF=new jsPDF({orientation:orientasi,unit:'mm',format:[width,height]});
      }

      for(let i=0;i<files.length;i++){
        const file=files[i];
        try{
          const imgData=await getImageDataUniversal(file);
          const img=new Image();
          img.decoding='async';
          img.src=imgData;
          await new Promise(res=>{img.onload=res;});

          let x=0,y=0,drawWidth=width,drawHeight=height;
          const imgRatio=img.width/img.height;
          const pageRatio=width/height;
          const scaleMode=document.getElementById('scaleMode').value;

          if(scaleMode==='fit'){
            if(imgRatio>pageRatio){drawWidth=width;drawHeight=width/imgRatio;y=(height-drawHeight)/2;}
            else{drawHeight=height;drawWidth=height*imgRatio;x=(width-drawWidth)/2;}
          }else if(scaleMode==='fill'){
            if(imgRatio>pageRatio){drawHeight=height;drawWidth=height*imgRatio;x=(width-drawWidth)/2;}
            else{drawWidth=width;drawHeight=width/imgRatio;y=(height-drawHeight)/2;}
          }
          // stretch = penuh default

          if(gabungPDF){
            if(i>0)gabungPDF.addPage([width,height],orientasi);
            gabungPDF.addImage(imgData,'JPEG',x,y,drawWidth,drawHeight);
            updateStatus(`Ditambahkan: ${file.name}`,'ok');
          }else{
            const pdf=new jsPDF({orientation:orientasi,unit:'mm',format:[width,height]});
            pdf.addImage(imgData,'JPEG',x,y,drawWidth,drawHeight);
            pdf.save(file.name.replace(/\.[^/.]+$/,'')+".pdf");
            updateStatus(`Selesai: ${file.name}`,'ok');
          }
        }catch(e){
          console.error(e);
          updateStatus(`Gagal memproses: ${file.name} (${e.message||e})`,'err');
        }
      }

      if(gabungPDF){
        gabungPDF.save("gabungan.pdf");
        updateStatus("Semua gambar digabung ke gabungan.pdf",'ok');
      }
    });

    clearAll();
  </script>
</body>
</html>
