<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>IMG → PDF (All Formats)</title>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Decoder TIFF & HEIC -->
  <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --bg:#eef2f7; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#dbe4f1;
      --brand:#1e3a8a; --brand-2:#3b82f6; --ok:#16a34a; --warn:#ca8a04; --err:#dc2626;
      --shadow:0 10px 28px rgba(2,6,23,.10); --radius:14px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#96a3b8; --line:#1f2a44;
      --brand:#60a5fa; --brand-2:#3b82f6; --shadow:0 10px 28px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      font-family: Segoe UI, Roboto, system-ui, -apple-system, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.10), transparent),
                  radial-gradient(1000px 500px at 110% -20%, rgba(30,58,138,.10), transparent),
                  var(--bg);
      color:var(--text); padding:24px; margin:0;
    }
    header{
      max-width: 1040px; margin:0 auto 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .title{
      display:flex; align-items:center; gap:.6rem; color:var(--brand);
      font-weight:800; font-size:1.35rem;
    }
    .title i{ font-size:1.2rem }
    .toolbar{ display:flex; gap:.6rem; align-items:center }
    .btn{
      border:none; background:var(--brand); color:#fff; font-weight:700;
      padding:.6rem .9rem; border-radius:12px; cursor:pointer; box-shadow: var(--shadow);
      transition: transform .15s ease, filter .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05) }
    .btn.ghost{
      background:transparent; color:var(--brand); border:1px solid color-mix(in hsl, var(--brand), #fff 60%);
    }
    .btn.icon{ width:42px; height:42px; display:grid; place-items:center; padding:0; border-radius:12px }

    .wrap{ max-width:1040px; margin:0 auto; display:grid; gap:18px; grid-template-columns: 1fr 360px }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr } }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow: var(--shadow); padding:18px;
    }

    .controls{ display:flex; flex-wrap:wrap; gap:12px }
    .panel{ display:flex; flex-direction:column; gap:8px; min-width:220px; flex:1 }
    .label{ font-size:.9rem; color:var(--muted); font-weight:600 }

    /* Drop area */
    .drop{
      display:flex; align-items:center; gap:12px; padding:14px 16px; min-width:280px;
      border:2px dashed var(--line); border-radius:12px; background:#fff0; cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    [data-theme="dark"] .drop{ background:rgba(255,255,255,0.02) }
    .drop:hover{ border-color: var(--brand-2); background: color-mix(in hsl, var(--brand-2), transparent 92%) }
    .drop strong{ display:block; margin-bottom:2px }
    input[type=file]{ display:none }

    /* Select & input */
    select, input[type=number]{
      width:100%; padding:.7rem .8rem; border-radius:12px; border:1px solid var(--line);
      background:transparent; color:var(--text);
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    select:focus, input[type=number]:focus{
      border-color: var(--brand-2); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand-2), transparent 80%);
    }
    .row{ display:flex; gap:8px }
    .row > *{ flex:1 }

    /* Segmented control */
    .seg{ display:flex; border:1px solid var(--line); border-radius:12px; padding:4px; gap:4px; background: color-mix(in hsl, var(--bg), #000 0%) }
    .seg button{
      flex:1; padding:.55rem; border:none; border-radius:10px; background:transparent; color:var(--text);
      font-weight:700; cursor:pointer;
    }
    .seg button.active{ background: color-mix(in hsl, var(--brand-2), transparent 86%); color: var(--brand) }
    .seg.sm button{ padding:.45rem; font-size:.92rem }

    /* Status */
    .status{ max-height:52vh; overflow:auto }
    .status ul{ list-style:none; padding:0; margin:0 }
    .status li{ padding:.5rem .1rem; border-bottom:1px dashed var(--line); font-size:.95rem; display:flex; gap:.6rem; align-items:center }
    .status .i{ width:20px; text-align:center; font-weight:800 }
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }

    /* Action bar */
    .action{ position:sticky; bottom:0; left:0; right:0; display:flex; justify-content:space-between; align-items:center;
      margin-top:14px; padding:10px; border-top:1px solid var(--line); background: color-mix(in hsl, var(--card), #000 0%); border-radius:0 0 var(--radius) var(--radius) }

    .muted{ color:var(--muted); font-size:.92rem }
    footer{ max-width:1040px; margin:16px auto 0; text-align:center; color:var(--muted); font-size:.9rem }
  </style>
</head>
<body>
  <header>
    <div class="title"><i class="fa-solid fa-images"></i> IMG → PDF</div>
    <div class="toolbar">
      <button id="themeBtn" class="btn icon" title="Toggle tema (Light/Dark)"><i class="fa-solid fa-moon"></i></button>
      <button id="resetTop" class="btn ghost"><i class="fa-solid fa-rotate-left"></i> Reset</button>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="controls">
        <label class="panel">
          <span class="label">Pilih / Taruh gambar</span>
          <label class="drop" for="upload">
            <i class="fa-solid fa-upload"></i>
            <div>
              <strong>Taruh file di sini / Klik untuk pilih</strong>
              <div class="muted">JPG • PNG • WebP • GIF • BMP • SVG • TIFF • HEIC</div>
            </div>
          </label>
          <input id="upload" type="file" accept=".jpg,.jpeg,.png,.webp,.gif,.bmp,.tif,.tiff,.heic,.heif,.svg,image/*" multiple>
        </label>

        <div class="panel">
          <span class="label">Ukuran halaman (mm)</span>
          <select id="ukuran" onchange="toggleCustomSize(this.value)">
            <option value="420x297">A3</option>
            <option value="297x210" selected>A4</option>
            <option value="210x148.5">A5</option>
            <option value="470x310">47×31 cm</option>
            <option value="480x320">48×32 cm</option>
            <option value="custom">Custom</option>
          </select>

          <div id="customSizeInputs" style="display:none">
            <div class="row">
              <input id="customWidth" type="number" step="0.01" placeholder="Lebar (mm)">
              <input id="customHeight" type="number" step="0.01" placeholder="Tinggi (mm)">
            </div>
            <div class="muted">Auto orientasi mengikuti rasio: lebar &lt; tinggi → Portrait</div>
          </div>
        </div>

        <div class="panel">
          <span class="label">Orientasi Halaman</span>
          <div class="seg sm" id="orientasiSeg">
            <button data-val="auto" class="active" title="Deteksi otomatis dari gambar / ukuran">Auto</button>
            <button data-val="portrait">Portrait</button>
            <button data-val="landscape">Landscape</button>
          </div>
        </div>

        <div class="panel">
          <span class="label">Mode Gabung</span>
          <div class="seg sm" id="gabungSeg">
            <button data-val="gabung" class="active">Gabung</button>
            <button data-val="pisah">Pisah</button>
          </div>
        </div>

        <div class="panel">
          <span class="label">Scale</span>
          <div class="seg sm" id="scaleSeg">
            <button data-val="fill" class="active">Fill</button>
            <button data-val="fit">Fit</button>
            <button data-val="stretch">Stretch</button>
          </div>
        </div>
      </div>

      <div class="action">
        <div class="muted"><i class="fa-regular fa-circle-question"></i> HEIC & TIFF otomatis didecode.</div>
        <div style="display:flex; gap:.6rem">
          <button id="convertBtn" class="btn"><i class="fa-solid fa-file-arrow-down"></i> Ubah & Unduh PDF</button>
        </div>
      </div>
    </section>

    <aside class="card status" id="statusBox">
      <ul id="statusList"></ul>
      <div class="action">
        <div class="muted">Log proses konversi</div>
        <button id="resetBtn" class="btn ghost">Bersihkan Log</button>
      </div>
    </aside>
  </div>

  <footer>© 2025 Spectrum Digital Printing</footer>

  <canvas id="canvas" style="display:none"></canvas>

  <script>
    const { jsPDF } = window.jspdf;

    // ====== UI helpers ======
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => document.querySelectorAll(q);
    function segVal(id){ const a=[...$(id).querySelectorAll('button')].find(b=>b.classList.contains('active')); return a?.dataset.val }
    function bindSeg(id, cb){
      $(id).addEventListener('click', e=>{
        if(e.target.tagName!=='BUTTON') return;
        [...$(id).children].forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active'); cb?.(e.target.dataset.val);
      });
    }

    // ====== Elements ======
    const upload = $('#upload');
    const ukuranSel = $('#ukuran');
    const customBox = $('#customSizeInputs');
    const statusList = $('#statusList');
    const convertBtn = $('#convertBtn');
    const resetBtn = $('#resetBtn');
    const resetTop = $('#resetTop');
    const themeBtn = $('#themeBtn');
    const canvas = $('#canvas');
    const ctx = canvas.getContext('2d');

    // ====== Status log ======
    function updateStatus(text, type='ok'){
      const li=document.createElement('li');
      const icon = type==='ok' ? '<span class="i ok">✓</span>' : type==='warn' ? '<span class="i warn">!</span>' : '<span class="i err">✖</span>';
      li.innerHTML = icon + '<span>'+text+'</span>';
      statusList.appendChild(li);
      statusList.parentElement.scrollTop = statusList.parentElement.scrollHeight;
    }

    // ====== Theme toggle ======
    themeBtn.addEventListener('click', ()=>{
      const root=document.documentElement;
      const now=root.getAttribute('data-theme')||'light';
      root.setAttribute('data-theme', now==='light'?'dark':'light');
      themeBtn.innerHTML = now==='light' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    });

    // ====== Segmented bindings ======
    bindSeg('#orientasiSeg');
    bindSeg('#gabungSeg');
    bindSeg('#scaleSeg');

    // ====== Drop handlers ======
    const drop = document.querySelector('label.drop');
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor='var(--brand-2)'; });
    drop.addEventListener('dragleave', e=>{ e.preventDefault(); drop.style.borderColor='var(--line)'; });
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.style.borderColor='var(--line)';
      if(e.dataTransfer.files.length) upload.files = e.dataTransfer.files;
      updateStatus(`${upload.files.length} file dipilih (drag-drop)`, 'ok');
    });

    // ====== Custom size toggle ======
    function toggleCustomSize(value){
      customBox.style.display = value==='custom' ? 'block' : 'none';
    }
    window.toggleCustomSize = toggleCustomSize;

    // ====== File reading helpers ======
    function readAsDataURL(blob){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=reject;
        fr.readAsDataURL(blob);
      });
    }
    function readAsArrayBuffer(blob){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=reject;
        fr.readAsArrayBuffer(blob);
      });
    }
    function drawToCanvasFromImage(img){
      canvas.width = img.width; canvas.height = img.height;
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0);
      return canvas.toDataURL('image/jpeg', 1.0);
    }

    // ====== Decoders ======
    async function decodeTIFF(file){
      if (typeof UTIF==='undefined' || !UTIF.decode) throw new Error('UTIF.js tidak tersedia');
      const buf = await readAsArrayBuffer(file);
      const ifds = UTIF.decode(buf);
      if(!ifds || !ifds.length) throw new Error('Tidak ada halaman TIFF.');
      UTIF.decodeImage(buf, ifds[0]);
      const rgba = UTIF.toRGBA8(ifds[0]);
      const w = ifds[0].width, h = ifds[0].height;
      canvas.width = w; canvas.height = h;
      const imgData = new ImageData(new Uint8ClampedArray(rgba), w, h);
      ctx.putImageData(imgData, 0, 0);
      // putihkan background
      const white = document.createElement('canvas');
      white.width = w; white.height = h;
      const wctx = white.getContext('2d');
      wctx.fillStyle='#fff'; wctx.fillRect(0,0,w,h);
      wctx.drawImage(canvas,0,0);
      return white.toDataURL('image/jpeg', 1.0);
    }
    async function decodeHEIC(file){
      if(typeof heic2any==='undefined') throw new Error('heic2any tidak tersedia');
      const jpegBlob = await heic2any({ blob:file, toType:'image/jpeg', quality:1 });
      return await readAsDataURL(jpegBlob);
    }
    async function decodeWithImageElement(file){
      const dataURL = await readAsDataURL(file);
      const img = new Image();
      img.decoding='async';
      return new Promise((resolve,reject)=>{
        img.onload = ()=> resolve(drawToCanvasFromImage(img));
        img.onerror = ()=> reject(new Error('Gagal memuat gambar'));
        img.src = dataURL;
      });
    }
    async function getImageDataUniversal(file){
      const type = (file.type||'').toLowerCase();
      const name = (file.name||'').toLowerCase();
      try{
        if (type.includes('heic') || type.includes('heif') || name.endsWith('.heic') || name.endsWith('.heif')){
          updateStatus(`Konversi HEIC → JPEG: ${file.name}`, 'warn');
          return await decodeHEIC(file);
        }
        if (type.includes('tiff') || name.endsWith('.tif') || name.endsWith('.tiff')){
          updateStatus(`Decode TIFF: ${file.name}`, 'warn');
          return await decodeTIFF(file);
        }
        return await decodeWithImageElement(file);
      }catch(err){
        try{
          updateStatus(`Fallback standar untuk ${file.name}`, 'warn');
          return await decodeWithImageElement(file);
        }catch(e2){ throw err; }
      }
    }

    // ====== Core sizing/orientation helpers ======
    function parseSizeMM(val){ const [w,h] = val.split('x').map(Number); return {w, h}; }
    function mmFormatFor(ukuranVal, customW, customH, orientasiMode, imgW, imgH){
      // Returns { width, height, orientation } per halaman
      // Rules:
      // - if orientasiMode == 'portrait'/'landscape' -> force
      // - else (auto):
      //    * if ukuran==custom and customW/H valid -> by size ratio (W<H → portrait)
      //    * else → by image ratio (imgW<imgH → portrait)
      const isCustom = ukuranVal==='custom';
      if(orientasiMode==='portrait' || orientasiMode==='landscape'){
        const base = isCustom ? {w:customW, h:customH} : parseSizeMM(ukuranVal);
        const forcePortrait = orientasiMode==='portrait';
        const W = forcePortrait ? Math.min(base.w, base.h) : Math.max(base.w, base.h);
        const H = forcePortrait ? Math.max(base.w, base.h) : Math.min(base.w, base.h);
        return { width: W, height: H, orientation: forcePortrait ? 'portrait' : 'landscape' };
      }
      // auto:
      let wantPortrait;
      if(isCustom && customW && customH){
        wantPortrait = customW < customH;
      }else if(imgW && imgH){
        wantPortrait = imgW < imgH;
      }else{
        // fallback: treat parsed size
        const base = parseSizeMM(ukuranVal);
        wantPortrait = base.w < base.h;
      }
      const base = isCustom ? {w:customW, h:customH} : parseSizeMM(ukuranVal);
      const W = wantPortrait ? Math.min(base.w, base.h) : Math.max(base.w, base.h);
      const H = wantPortrait ? Math.max(base.w, base.h) : Math.min(base.w, base.h);
      return { width: W, height: H, orientation: wantPortrait ? 'portrait' : 'landscape' };
    }

    function computePlacement(widthMM, heightMM, imgW, imgH, scaleMode){
      // Return {x,y,w,h} in mm for jsPDF.addImage (unit: mm)
      const pageRatio = widthMM / heightMM;
      const imgRatio = imgW / imgH;
      let drawW = widthMM, drawH = heightMM, x=0, y=0;

      if(scaleMode==='fit'){
        if(imgRatio>pageRatio){ drawW=widthMM; drawH=widthMM/imgRatio; y=(heightMM-drawH)/2; }
        else{ drawH=heightMM; drawW=heightMM*imgRatio; x=(widthMM-drawW)/2; }
      }else if(scaleMode==='fill'){
        if(imgRatio>pageRatio){ drawH=heightMM; drawW=heightMM*imgRatio; x=(widthMM-drawW)/2; }
        else{ drawW=widthMM; drawH=widthMM/imgRatio; y=(heightMM-drawH)/2; }
      } // stretch = full page

      return {x,y,w:drawW,h:drawH};
    }

    // ====== Convert ======
    async function convert(){
      statusList.innerHTML='';
      const files = upload.files;
      if(!files.length){ updateStatus('Belum ada gambar dipilih','err'); return; }

      const ukuranVal = ukuranSel.value;
      const orientasiMode = segVal('#orientasiSeg');   // 'auto' | 'portrait' | 'landscape'
      const gabungMode = segVal('#gabungSeg');         // 'gabung' | 'pisah'
      const scaleMode = segVal('#scaleSeg');           // 'fill' | 'fit' | 'stretch'

      let customW = parseFloat($('#customWidth').value);
      let customH = parseFloat($('#customHeight').value);
      if(ukuranVal==='custom'){
        if(!customW || !customH){ updateStatus('Isi ukuran custom dengan benar','err'); return; }
      }

      let pdf = null; // for gabung

      for(let i=0;i<files.length;i++){
        const file = files[i];
        try{
          const imgData = await getImageDataUniversal(file);
          const img = new Image(); img.decoding='async'; img.src = imgData;
          await new Promise(res=>{ img.onload = res; });

          // Orientasi & ukuran halaman per gambar:
          const fmt = mmFormatFor(ukuranVal, customW, customH, orientasiMode, img.width, img.height);
          const place = computePlacement(fmt.width, fmt.height, img.width, img.height, scaleMode);

          if(gabungMode==='gabung'){
            if(!pdf){
              pdf = new jsPDF({ orientation: fmt.orientation, unit:'mm', format:[fmt.width, fmt.height] });
            }else{
              pdf.addPage([fmt.width, fmt.height], fmt.orientation);
            }
            // Pakai JPEG untuk konsistensi (imgData sudah JPEG dari canvas/decoder)
            pdf.addImage(imgData, 'JPEG', place.x, place.y, place.w, place.h);
            updateStatus(`Ditambahkan: ${file.name} (${fmt.orientation}, ${fmt.width}×${fmt.height} mm)`, 'ok');
          }else{
            const single = new jsPDF({ orientation: fmt.orientation, unit:'mm', format:[fmt.width, fmt.height] });
            single.addImage(imgData, 'JPEG', place.x, place.y, place.w, place.h);
            const outName = file.name.replace(/\.[^/.]+$/,'') + ".pdf";
            single.save(outName);
            updateStatus(`Selesai: ${outName}`, 'ok');
          }
        }catch(e){
          console.error(e);
          updateStatus(`Gagal memproses: ${file.name} (${e.message||e})`, 'err');
        }
      }

      if(pdf){
        pdf.save('gabungan.pdf');
        updateStatus('Semua gambar digabung → gabungan.pdf', 'ok');
      }
    }

    // ====== Actions ======
    convertBtn.addEventListener('click', convert);
    function clearAll(){
      upload.value=''; statusList.innerHTML='';
      ukuranSel.value='297x210'; toggleCustomSize('297x210');
      // reset segments
      $$('#orientasiSeg button').forEach(b=>b.classList.toggle('active', b.dataset.val==='auto'));
      $$('#gabungSeg button').forEach(b=>b.classList.toggle('active', b.dataset.val==='gabung'));
      $$('#scaleSeg button').forEach(b=>b.classList.toggle('active', b.dataset.val==='fill'));
      updateStatus('Form direset', 'ok');
    }
    resetBtn.addEventListener('click', ()=>{ statusList.innerHTML=''; updateStatus('Log dibersihkan','ok'); });
    resetTop.addEventListener('click', clearAll);

    // init
    toggleCustomSize(ukuranSel.value);
  </script>
</body>
</html>