<!doctype html>
<html lang="id" data-theme="light">
<head>
  <meta charset="utf-8">
  <title>PDF → IMG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{
      --bg:#eef2f7; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#dbe4f1;
      --brand:#1e3a8a; --brand-2:#3b82f6; --ok:#16a34a; --err:#dc2626;
      --shadow:0 10px 28px rgba(2,6,23,.10); --radius:14px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#96a3b8; --line:#1f2a44;
      --brand:#60a5fa; --brand-2:#3b82f6; --shadow:0 10px 28px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      font-family: Segoe UI, Roboto, system-ui, -apple-system, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.10), transparent),
                  radial-gradient(1000px 500px at 110% -20%, rgba(30,58,138,.10), transparent),
                  var(--bg);
      color:var(--text); padding:24px; margin:0;
    }
    header{
      max-width: 1040px; margin:0 auto 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .title{ display:flex; align-items:center; gap:.6rem; color:var(--brand); font-weight:800; font-size:1.35rem; }
    .title i{ font-size:1.1rem }
    .toolbar{ display:flex; gap:.6rem; align-items:center }
    .btn{ border:none; background:var(--brand); color:#fff; font-weight:700; padding:.6rem .9rem; border-radius:12px; cursor:pointer; box-shadow: var(--shadow); transition: transform .15s ease, filter .15s ease; }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05) }
    .btn.ghost{ background:transparent; color:var(--brand); border:1px solid color-mix(in hsl, var(--brand), #fff 60%); }
    .btn.icon{ width:42px; height:42px; display:grid; place-items:center; padding:0; border-radius:12px }

    .wrap{ max-width:1040px; margin:0 auto; display:grid; gap:18px; grid-template-columns: 1fr 360px }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr } }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow: var(--shadow); padding:18px;
    }
    .controls{ display:flex; flex-wrap:wrap; gap:12px }
    .panel{ display:flex; flex-direction:column; gap:8px; min-width:220px; flex:1 }
    .label{ font-size:.9rem; color:var(--muted); font-weight:600 }

    .drop{
      display:flex; align-items:center; gap:12px; padding:14px 16px; min-width:280px;
      border:2px dashed var(--line); border-radius:12px; background:#fff0; cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    [data-theme="dark"] .drop{ background:rgba(255,255,255,0.02) }
    .drop:hover{ border-color: var(--brand-2); background: color-mix(in hsl, var(--brand-2), transparent 92%) }
    .drop strong{ display:block; margin-bottom:2px }
    input[type=file]{ display:none }

    select, input[type=number]{
      width:100%; padding:.7rem .8rem; border-radius:12px; border:1px solid var(--line);
      background:transparent; color:var(--text);
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    select:focus, input[type=number]:focus{
      border-color: var(--brand-2); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand-2), transparent 80%);
    }
    .row{ display:flex; gap:8px } .row>*{ flex:1 }

    .seg{ display:flex; border:1px solid var(--line); border-radius:12px; padding:4px; gap:4px; background: color-mix(in hsl, var(--bg), #000 0%) }
    .seg button{
      flex:1; padding:.55rem; border:none; border-radius:10px; background:transparent; color:var(--text);
      font-weight:700; cursor:pointer;
    }
    .seg button.active{ background: color-mix(in hsl, var(--brand-2), transparent 86%); color: var(--brand) }
    .seg.sm button{ padding:.45rem; font-size:.92rem }

    .chk{ display:flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none }
    .chk input[type=checkbox]{
      appearance:none; -webkit-appearance:none; width:20px; height:20px; border-radius:6px;
      border:1.5px solid var(--line); background:transparent; display:grid; place-items:center;
      transition: all .15s ease; position:relative;
    }
    .chk input[type=checkbox]::after{
      content:""; width:12px; height:12px; border-radius:3px; transform:scale(0); transition: transform .12s ease;
      background: var(--brand-2);
    }
    .chk input[type=checkbox]:checked{ border-color: color-mix(in hsl, var(--brand-2), #fff 40%); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand-2), transparent 85%); }
    .chk input[type=checkbox]:checked::after{ transform:scale(1); }
    .chk span{ color:var(--muted) }

    .status{ max-height:52vh; overflow:auto }
    .status ul{ list-style:none; padding:0; margin:0 }
    .status li{ padding:.5rem .1rem; border-bottom:1px dashed var(--line); font-size:.95rem; display:flex; gap:.6rem; align-items:center }
    .ok{ color:var(--ok) } .err{ color:var(--err) }

    .action{
      position:sticky; bottom:0; left:0; right:0; display:flex; justify-content:space-between; align-items:center;
      margin-top:14px; padding:10px; border-top:1px solid var(--line); background: color-mix(in hsl, var(--card), #000 0%); border-radius:0 0 var(--radius) var(--radius)
    }
    .muted{ color:var(--muted); font-size:.92rem }
    footer{ max-width:1040px; margin:16px auto 0; text-align:center; color:var(--muted); font-size:.9rem }
  </style>
</head>
<body>
  <header>
    <div class="title"><i class="fa-solid fa-file-pdf"></i> PDF → IMG</div>
    <div class="toolbar">
      <button id="themeBtn" class="btn icon" title="Toggle tema (Light/Dark)"><i class="fa-solid fa-moon"></i></button>
      <button id="resetTop" class="btn ghost"><i class="fa-solid fa-rotate-left"></i> Reset</button>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="controls">
        <label class="panel">
          <span class="label">Pilih / Taruh file PDF</span>
          <label class="drop" for="fileInput" id="dropArea">
            <i class="fa-solid fa-upload"></i>
            <div>
              <strong>Taruh file di sini / Klik untuk pilih</strong>
              <div class="muted">Hanya 1 file PDF</div>
            </div>
          </label>
          <input id="fileInput" type="file" accept="application/pdf">
        </label>

        <div class="panel">
          <span class="label">Resolusi (dpi)</span>
          <select id="dpiSelect">
            <option value="300">300</option>
            <option value="400">400</option>
            <option value="500" selected>500</option>
            <option value="800">800</option>
          </select>
        </div>

        <div class="panel">
          <span class="label">Mode Resize</span>
          <div class="seg sm" id="modeResizeSeg">
            <button data-val="asli" class="active">Asli</button>
            <button data-val="fit">Fit</button>
            <button data-val="fill">Fill</button>
            <button data-val="stretch">Stretch</button>
          </div>
          <select id="modeResize" style="display:none">
            <option value="asli" selected>Do Not Scale</option>
            <option value="fit">Fit</option>
            <option value="fill">Fill</option>
            <option value="stretch">Stretch</option>
          </select>
        </div>

        <div class="panel" style="min-width:240px">
          <span class="label">Ukuran target (mm)</span>
          <div class="row">
            <input id="widthMm" type="number" step="0.01" placeholder="Lebar (mm)">
            <input id="heightMm" type="number" step="0.01" placeholder="Tinggi (mm)">
          </div>
          <label class="chk" title="Gunakan ukuran asli tiap halaman">
            <input id="useOriginalSize" type="checkbox" checked>
            <span>Gunakan ukuran asli tiap halaman</span>
          </label>
        </div>

        <div class="panel">
          <label class="chk" title="Unduh sebagai ZIP (tidak default)">
            <!-- default: TIDAK checked -->
            <input id="zipOutput" type="checkbox">
            <span>Unduh sebagai ZIP</span>
          </label>
          <div class="muted">Centang jika halaman banyak / browser blokir multi-download</div>
        </div>

        <div class="panel" style="align-items:flex-end">
          <div class="muted" id="detectedSize">Belum ada file dipilih</div>
        </div>
      </div>

      <div class="action">
        <div class="muted"><i class="fa-regular fa-circle-question"></i> Output JPG putih, ukuran fisik ikut mm + DPI yang dipilih</div>
        <div style="display:flex;gap:.6rem">
          <button id="convertBtn" class="btn"><i class="fa-solid fa-file-arrow-down"></i> Ubah & Unduh JPG</button>
        </div>
      </div>
    </section>

    <aside class="card status" id="statusBox">
      <ul id="statusList"></ul>
      <div class="action">
        <div class="muted">Log proses konversi</div>
        <button id="resetBtn" class="btn ghost">Bersihkan Log</button>
      </div>
    </aside>
  </div>

  <footer>© 2025 Spectrum Digital Printing</footer>

  <canvas id="renderCanvas" style="display:none"></canvas>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- JSZip & FileSaver untuk ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // ====== Tema ======
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', ()=>{
      const root=document.documentElement;
      const now=root.getAttribute('data-theme')||'light';
      root.setAttribute('data-theme', now==='light'?'dark':'light');
      themeBtn.innerHTML = now==='light' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    });

    // ====== pdf.js ======
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // ====== Referensi elemen ======
    const fileInput = document.getElementById('fileInput');
    const dropArea = document.getElementById('dropArea');
    const statusList = document.getElementById('statusList');
    const statusBox = document.getElementById('statusBox');
    const dpiSelect = document.getElementById('dpiSelect');
    const modeResize = document.getElementById('modeResize');
    const modeResizeSeg = document.getElementById('modeResizeSeg');
    const widthMm = document.getElementById('widthMm');
    const heightMm = document.getElementById('heightMm');
    const useOriginalSize = document.getElementById('useOriginalSize');
    const zipOutput = document.getElementById('zipOutput');
    const detectedSize = document.getElementById('detectedSize');
    const convertBtn = document.getElementById('convertBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resetTop = document.getElementById('resetTop');
    const canvas = document.getElementById('renderCanvas');
    const ctx = canvas.getContext('2d');

    let loadedPdf = null;
    let loadedPdfName = '';
    let firstPageSizePts = null; // {w,h} pts

    function updateStatus(text, ok = true){
      const li = document.createElement('li');
      li.innerHTML = ok ? '<span class="ok">✓</span> ' + text : '<span class="err">✖</span> ' + text;
      statusList.appendChild(li);
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    // ====== Segmented Mode Resize ======
    modeResizeSeg.addEventListener('click', (e)=>{
      if(e.target.tagName!=='BUTTON') return;
      [...modeResizeSeg.children].forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      modeResize.value = e.target.dataset.val;
    });
    (function initSeg(){
      const current = modeResize.value || 'asli';
      [...modeResizeSeg.children].forEach(b=>{
        b.classList.toggle('active', b.dataset.val === current);
      });
    })();

    // ====== Drag & Drop ======
    dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.style.borderColor='var(--brand-2)'});
    dropArea.addEventListener('dragleave',e=>{e.preventDefault();dropArea.style.borderColor='var(--line)'});
    dropArea.addEventListener('drop',e=>{
      e.preventDefault();
      dropArea.style.borderColor='var(--line)';
      if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
      fileChanged();
    });
    fileInput.addEventListener('change',fileChanged);

    function clearAll(){
      fileInput.value = '';
      loadedPdf = null;
      loadedPdfName = '';
      firstPageSizePts = null;
      detectedSize.textContent = 'Belum ada file dipilih';
      statusList.innerHTML = '';
      widthMm.value = '';
      heightMm.value = '';
      useOriginalSize.checked = true;
      // default: ZIP OFF
      zipOutput.checked = false;
      // default: 500 DPI
      dpiSelect.value = '500';
      modeResize.value = 'asli';
      [...modeResizeSeg.children].forEach(b=>b.classList.toggle('active', b.dataset.val==='asli'));
      widthMm.disabled = true;
      heightMm.disabled = true;
    }
    resetBtn.addEventListener('click',()=>{ clearAll(); updateStatus('Form di-reset (input & log dibersihkan)'); });
    resetTop.addEventListener('click',()=>{ clearAll(); updateStatus('Form di-reset'); });

    async function fileChanged(){
      statusList.innerHTML = '';
      const file = fileInput.files && fileInput.files[0];
      if(!file) return;
      if(file.type !== 'application/pdf'){ updateStatus('Bukan file PDF', false); return; }
      loadedPdfName = file.name.replace(/\.[^/.]+$/,'');
      updateStatus('Membaca file: ' + file.name);
      try{
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({data:arrayBuffer});
        const pdf = await loadingTask.promise;
        loadedPdf = pdf;

        const pg1 = await pdf.getPage(1);
        const vp1 = pg1.getViewport({scale:1});
        firstPageSizePts = { w: vp1.width, h: vp1.height };
        const mmW = ((vp1.width/72)*25.4).toFixed(2);
        const mmH = ((vp1.height/72)*25.4).toFixed(2);
        detectedSize.textContent = `Deteksi ukuran (halaman 1): ${mmW} × ${mmH} mm`;
        if(useOriginalSize.checked){
          widthMm.value = mmW;
          heightMm.value = mmH;
        }
        updateStatus('PDF dimuat: ' + pdf.numPages + ' halaman');
        pg1.cleanup();
      }catch(err){
        console.error(err);
        updateStatus('Gagal membaca PDF', false);
      }
    }

    const mmToInch = (mm)=> mm/25.4;
    function mmToPx(mm, dpi){ return Math.round(mmToInch(mm) * dpi); }

    function dataURLToUint8Array(dataUrl){
      const base64 = dataUrl.split(',')[1];
      const bin = atob(base64);
      const len = bin.length;
      const bytes = new Uint8Array(len);
      for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    function setJpegDPI(bytes, dpi){
      try{
        if(bytes[0] === 0xFF && bytes[1] === 0xD8 && bytes[2] === 0xFF && bytes[3] === 0xE0){
          if(String.fromCharCode(bytes[6],bytes[7],bytes[8],bytes[9],bytes[10]) === 'JFIF\0'){
            const dv = new DataView(bytes.buffer);
            dv.setUint8(13, 1);          // 1 = dpi
            dv.setUint16(14, dpi);       // Xdensity
            dv.setUint16(16, dpi);       // Ydensity
          }
        }
      }catch(e){
        console.warn('Gagal menyetel DPI di JPEG, gunakan default.', e);
      }
      return bytes;
    }

    function canvasToJPEGBytesWithDPI(canvas, dpi){
      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      let bytes = dataURLToUint8Array(dataUrl);
      bytes = setJpegDPI(bytes, dpi);
      return bytes;
    }

    convertBtn.addEventListener('click',async()=>{
      if(!loadedPdf){ updateStatus('Belum ada PDF yang dimuat', false); return; }

      const dpi = Number(dpiSelect.value);
      const mode = modeResize.value;
      const useOrig = useOriginalSize.checked;

      if(!useOrig){
        const wmm = Number(widthMm.value), hmm = Number(heightMm.value);
        if(!wmm || !hmm){
          updateStatus('Masukkan ukuran target (mm) terlebih dahulu', false);
          return;
        }
      }

      updateStatus(`Mulai konversi (${loadedPdf.numPages} halaman) pada ${dpi} DPI, mode: ${mode}`);

      const useZip = zipOutput.checked;
      const zip = useZip ? new JSZip() : null;

      for(let p=1;p<=loadedPdf.numPages;p++){
        try{
          const page = await loadedPdf.getPage(p);
          const vp1 = page.getViewport({scale:1});
          const origWpts = vp1.width, origHpts = vp1.height;

          let targWinch, targHinch;
          if(useOrig){
            targWinch = origWpts / 72;
            targHinch = origHpts / 72;
          }else{
            targWinch = mmToInch(Number(widthMm.value));
            targHinch = mmToInch(Number(heightMm.value));
          }

          const targWpx = Math.round(targWinch * dpi);
          const targHpx = Math.round(targHinch * dpi);

          const S_w = targWpx / origWpts;
          const S_h = targHpx / origHpts;
          let renderScale;
          if(mode === 'asli'){ renderScale = S_w; }
          else if(mode === 'fit'){ renderScale = Math.min(S_w,S_h); }
          else if(mode === 'fill'){ renderScale = Math.max(S_w,S_h); }
          else { renderScale = S_w; }

          const viewport = page.getViewport({scale: renderScale});
          canvas.width = Math.round(viewport.width);
          canvas.height = Math.round(viewport.height);
          const ctx2 = canvas.getContext('2d');
          ctx2.fillStyle = '#ffffff';
          ctx2.fillRect(0,0,canvas.width,canvas.height);
          await page.render({canvasContext:ctx2,viewport}).promise;

          const finalCanvas = document.createElement('canvas');
          finalCanvas.width = targWpx;
          finalCanvas.height = targHpx;
          const fctx = finalCanvas.getContext('2d');
          fctx.fillStyle = '#ffffff';
          fctx.fillRect(0,0,finalCanvas.width,finalCanvas.height);

          if(mode === 'asli' || mode === 'fit'){
            const dx = Math.round((targWpx - canvas.width)/2);
            const dy = Math.round((targHpx - canvas.height)/2);
            fctx.drawImage(canvas, dx, dy, canvas.width, canvas.height);
          }else if(mode === 'fill'){
            const sx = Math.max(0, Math.round((canvas.width - targWpx)/2));
            const sy = Math.max(0, Math.round((canvas.height - targHpx)/2));
            fctx.drawImage(canvas, sx, sy, targWpx, targHpx, 0, 0, targWpx, targHpx);
          }else{
            fctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, targWpx, targHpx);
          }

          const jpegBytes = canvasToJPEGBytesWithDPI(finalCanvas, dpi);
          const fileName = `${loadedPdfName}-(${p}).jpg`;

          if(useZip){
            zip.file(fileName, jpegBytes, {binary:true});
            updateStatus(`Halaman ${p} siap (ke ZIP) [${targWpx}×${targHpx}px @ ${dpi} DPI]`);
          }else{
            const blob = new Blob([jpegBytes], {type:'image/jpeg'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            updateStatus(`Halaman ${p} diunduh: ${fileName} [${targWpx}×${targHpx}px @ ${dpi} DPI]`);
          }

          page.cleanup();
        }catch(err){
          console.error(err);
          updateStatus('Gagal konversi halaman ' + p, false);
        }
      }

      if(useZip){
        const blob = await zip.generateAsync({type:'blob'});
        saveAs(blob, `${loadedPdfName}-pages.zip`);
        updateStatus('ZIP terunduh: semua halaman terkumpul');
      }

      updateStatus('Konversi selesai');
    });

    useOriginalSize.addEventListener('change',()=>{
      const use = useOriginalSize.checked;
      widthMm.disabled = use;
      heightMm.disabled = use;
      if(use && firstPageSizePts){
        const mmW = ((firstPageSizePts.w/72)*25.4).toFixed(2);
        const mmH = ((firstPageSizePts.h/72)*25.4).toFixed(2);
        widthMm.value = mmW;
        heightMm.value = mmH;
      }
    });

    (function init(){
      dpiSelect.value = '500';      // pastikan default 500 DPI
      zipOutput.checked = false;    // pastikan default zip = OFF
      widthMm.disabled = useOriginalSize.checked;
      heightMm.disabled = useOriginalSize.checked;
    })();
  </script>
</body>
</html>
