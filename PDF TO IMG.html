<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>PDF → IMG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Roboto,system-ui,-apple-system,Arial; background:#eef2f7; color:#222; padding:2rem;}
    h2{color:#1e3a8a;margin-bottom:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:0.8rem;align-items:center}
    input[type=file]{padding:1rem;border:2px dashed #cbd5e1;border-radius:10px;background:#fff}
    select,input[type=number]{padding:0.7rem;border-radius:8px;border:1px solid #d1d5db}
    label{font-size:0.95rem}
    .status{margin-top:1.2rem;max-height:46vh;overflow:auto;background:#fff;padding:1rem;border-radius:10px;box-shadow:0 6px 18px rgba(30,58,138,0.06)}
    .status ul{list-style:none;padding:0;margin:0}
    .status li{padding:0.4rem 0;border-bottom:1px dashed #eee;font-size:0.95rem}
    .status .ok{color:#16a34a}
    .status .err{color:#dc2626}
    .form-row{display:flex;gap:0.6rem;align-items:center}
    .panel{display:flex;flex-direction:column;gap:0.6rem}
    .small{font-size:0.85rem;color:#475569}
    .action-bar{position:sticky;bottom:0;left:0;right:0;background:#fff;padding:0.8rem;border-top:1px solid #e6eef9;box-shadow:0 -6px 18px rgba(30,58,138,0.04);display:flex;justify-content:space-between;align-items:center;margin-top:1rem}
    .action-bar .left{display:flex;gap:0.6rem}
    button{padding:0.7rem 1rem;border-radius:10px;border:none;background:#1e3a8a;color:#fff;font-weight:600;cursor:pointer}
    .btn-ghost{background:#fff;color:#1e3a8a;border:1px solid #cfe0ff}
    .meta{font-size:0.9rem;color:#334155}
    @media(max-width:720px){.controls{flex-direction:column}.form-row{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <h2><i class="fa-solid fa-file-pdf"></i> PDF → IMG</h2>

  <div class="controls">
    <label>
      <input id="fileInput" type="file" accept="application/pdf" style="display:none">
      <div id="dropArea" style="padding:1rem 1.2rem;border-radius:10px;background:#fff;border:2px dashed #cbd5e1;cursor:pointer;min-width:260px;text-align:left">
        <div><strong>Pilih / Taruh file PDF</strong></div>
        <div class="small">Klik untuk pilih PDF (hanya 1 file)</div>
      </div>
    </label>

    <div class="panel">
      <label class="small">Resolusi (dpi)</label>
      <select id="dpiSelect">
        <option value="300">300</option>
        <option value="400">400</option>
        <option value="500">500</option>
        <option value="800">800</option>
      </select>
    </div>

    <div class="panel">
      <label class="small">Mode Resize</label>
      <select id="modeResize">
        <option value="asli">Do Not Scale</option>
        <option value="fit">Fit</option>
        <option value="fill">Fill</option>
        <option value="stretch">Stretch</option>
      </select>
    </div>

    <div class="panel" style="min-width:240px">
      <div class="small">Ukuran target (mm)</div>
      <div class="form-row">
        <input id="widthMm" type="number" step="0.01" placeholder="Panjang (mm)" style="width:120px">
        <input id="heightMm" type="number" step="0.01" placeholder="Tinggi (mm)" style="width:120px">
      </div>
      <div class="small"><label><input id="useOriginalSize" type="checkbox" checked> Gunakan ukuran asli tiap halaman</label></div>
    </div>

    <div class="panel">
      <label class="small"><input id="zipOutput" type="checkbox" checked> Unduh sebagai ZIP (disarankan)</label>
      <div class="small">Menghindari blokir multi-unduhan</div>
    </div>

    <div style="margin-left:auto;display:flex;flex-direction:column;gap:0.4rem;align-items:flex-end">
      <div class="meta" id="detectedSize">Belum ada file dipilih</div>
    </div>
  </div>

  <div class="status" id="statusBox">
    <ul id="statusList"></ul>
  </div>

  <div class="action-bar">
    <div class="left">
      <button id="resetBtn" class="btn-ghost">Reset</button>
    </div>
    <div style="display:flex;gap:0.6rem">
      <button id="convertBtn">Ubah & Unduh JPG</button>
    </div>
  </div>

  <canvas id="renderCanvas" style="display:none"></canvas>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- JSZip & FileSaver untuk ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // Konfigurasi pdf.js
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const dropArea = document.getElementById('dropArea');
    const statusList = document.getElementById('statusList');
    const statusBox = document.getElementById('statusBox');
    const dpiSelect = document.getElementById('dpiSelect');
    const modeResize = document.getElementById('modeResize');
    const widthMm = document.getElementById('widthMm');
    const heightMm = document.getElementById('heightMm');
    const useOriginalSize = document.getElementById('useOriginalSize');
    const zipOutput = document.getElementById('zipOutput');
    const detectedSize = document.getElementById('detectedSize');
    const convertBtn = document.getElementById('convertBtn');
    const resetBtn = document.getElementById('resetBtn');
    const canvas = document.getElementById('renderCanvas');
    const ctx = canvas.getContext('2d');

    let loadedPdf = null;
    let loadedPdfName = '';
    let firstPageSizePts = null; // {w,h} pts

    function updateStatus(text, ok = true){
      const li = document.createElement('li');
      li.innerHTML = ok ? `<span class="ok">✓</span> ${text}` : `<span class="err">✖</span> ${text}`;
      statusList.appendChild(li);
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    // Drag & drop (TIDAK perlu handler click -> label sudah memicu input)
    dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.style.borderColor='#94a3b8'});
    dropArea.addEventListener('dragleave',e=>{e.preventDefault();dropArea.style.borderColor='#cbd5e1'});
    dropArea.addEventListener('drop',e=>{
      e.preventDefault();
      dropArea.style.borderColor='#cbd5e1';
      if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files;
      fileChanged();
    });
    fileInput.addEventListener('change',fileChanged);

    function clearAll(){
      fileInput.value = '';
      loadedPdf = null;
      loadedPdfName = '';
      firstPageSizePts = null;
      detectedSize.textContent = 'Belum ada file dipilih';
      statusList.innerHTML = '';
      widthMm.value = '';
      heightMm.value = '';
      useOriginalSize.checked = true;
      zipOutput.checked = true;
      dpiSelect.value = '300';
      modeResize.value = 'asli';
    }

    resetBtn.addEventListener('click',()=>{
      clearAll();
      updateStatus('Form di-reset (input & log dibersihkan)');
    });

    async function fileChanged(){
      statusList.innerHTML = '';
      const file = fileInput.files && fileInput.files[0];
      if(!file) return;
      if(file.type !== 'application/pdf'){ updateStatus('Bukan file PDF', false); return; }
      loadedPdfName = file.name.replace(/\.[^/.]+$/,'');
      updateStatus(`Membaca file: ${file.name}`);
      try{
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({data:arrayBuffer});
        const pdf = await loadingTask.promise;
        loadedPdf = pdf;

        // Baca ukuran halaman 1 untuk pratinjau
        const pg1 = await pdf.getPage(1);
        const vp1 = pg1.getViewport({scale:1});
        firstPageSizePts = { w: vp1.width, h: vp1.height };
        const mmW = ((vp1.width/72)*25.4).toFixed(2);
        const mmH = ((vp1.height/72)*25.4).toFixed(2);
        detectedSize.textContent = `Deteksi ukuran (halaman 1): ${mmW} × ${mmH} mm`;
        widthMm.value = mmW; heightMm.value = mmH;
        useOriginalSize.checked = true;
        updateStatus(`PDF dimuat: ${pdf.numPages} halaman`);
        pg1.cleanup();
      }catch(err){
        console.error(err);
        updateStatus('Gagal membaca PDF', false);
      }
    }

    // Utility
    const mmToInch = (mm)=> mm/25.4;

    convertBtn.addEventListener('click',async()=>{
      if(!loadedPdf){ updateStatus('Belum ada PDF yang dimuat', false); return; }

      const dpi = Number(dpiSelect.value);
      const mode = modeResize.value;
      const useOrig = useOriginalSize.checked;

      // Validasi input target size bila tidak pakai ukuran asli
      if(!useOrig){
        const wmm = Number(widthMm.value), hmm = Number(heightMm.value);
        if(!wmm || !hmm){ updateStatus('Masukkan ukuran target (mm) terlebih dahulu', false); return; }
      }

      updateStatus(`Mulai konversi (${loadedPdf.numPages} halaman) pada ${dpi} dpi, mode: ${mode}`);

      // ZIP opsional
      const useZip = zipOutput.checked;
      const zip = useZip ? new JSZip() : null;

      for(let p=1;p<=loadedPdf.numPages;p++){
        try{
          const page = await loadedPdf.getPage(p);
          const vp1 = page.getViewport({scale:1});
          const origWpts = vp1.width, origHpts = vp1.height;

          // Tentukan ukuran target PER HALAMAN
          let targWinch, targHinch;
          if(useOrig){
            // pakai ukuran asli halaman p
            targWinch = origWpts/72;
            targHinch = origHpts/72;
          }else{
            // pakai ukuran dari input
            targWinch = mmToInch(Number(widthMm.value));
            targHinch = mmToInch(Number(heightMm.value));
          }

          const targWpx = Math.round(targWinch * dpi);
          const targHpx = Math.round(targHinch * dpi);

          // Skala render agar mapping pas ke target (tergantung mode)
          const S_w = targWpx / origWpts;
          const S_h = targHpx / origHpts;
          let renderScale;
          if(mode === 'asli'){ renderScale = S_w; }
          else if(mode === 'fit'){ renderScale = Math.min(S_w,S_h); }
          else if(mode === 'fill'){ renderScale = Math.max(S_w,S_h); }
          else { /* stretch */ renderScale = S_w; }

          // Render halaman ke kanvas perantara
          const viewport = page.getViewport({scale: renderScale});
          canvas.width = Math.round(viewport.width);
          canvas.height = Math.round(viewport.height);
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          await page.render({canvasContext:ctx,viewport}).promise;

          // Kanvas final (ukuran tepat sesuai target pixel)
          const finalCanvas = document.createElement('canvas');
          finalCanvas.width = targWpx;
          finalCanvas.height = targHpx;
          const fctx = finalCanvas.getContext('2d');
          fctx.fillStyle = '#ffffff';
          fctx.fillRect(0,0,finalCanvas.width,finalCanvas.height);

          if(mode === 'asli' || mode === 'fit'){
            const dx = Math.round((targWpx - canvas.width)/2);
            const dy = Math.round((targHpx - canvas.height)/2);
            fctx.drawImage(canvas, dx, dy, canvas.width, canvas.height);
          }else if(mode === 'fill'){
            // crop center
            const sx = Math.max(0, Math.round((canvas.width - targWpx)/2));
            const sy = Math.max(0, Math.round((canvas.height - targHpx)/2));
            fctx.drawImage(canvas, sx, sy, targWpx, targHpx, 0, 0, targWpx, targHpx);
          }else{ // stretch
            fctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, targWpx, targHpx);
          }

          // Simpan output
          if(useZip){
            // masukkan ke ZIP sebagai JPEG dengan kualitas tinggi
            const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.95);
            const bin = atob(dataUrl.split(',')[1]);
            const len = bin.length;
            const bytes = new Uint8Array(len);
            for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
            zip.file(`${loadedPdfName}-(${p}).jpg`, bytes, {binary:true});
            updateStatus(`Halaman ${p} siap (ditambahkan ke ZIP)`);
          }else{
            // unduh satu per satu (bisa diblokir di beberapa browser)
            const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.95);
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `${loadedPdfName}-(${p}).jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            updateStatus(`Halaman ${p} diunduh: ${link.download}`);
          }

          page.cleanup();
        }catch(err){
          console.error(err);
          updateStatus(`Gagal konversi halaman ${p}`, false);
        }
      }

      if(useZip){
        const blob = await zip.generateAsync({type:'blob'});
        saveAs(blob, `${loadedPdfName}-pages.zip`);
        updateStatus('ZIP terunduh: semua halaman terkumpul');
      }

      updateStatus('Konversi selesai');
    });

    // Toggle ukuran input bila pakai ukuran asli
    useOriginalSize.addEventListener('change',()=>{
      const use = useOriginalSize.checked;
      widthMm.disabled = use; heightMm.disabled = use;
      if(use && firstPageSizePts){
        const mmW = ((firstPageSizePts.w/72)*25.4).toFixed(2);
        const mmH = ((firstPageSizePts.h/72)*25.4).toFixed(2);
        widthMm.value = mmW; heightMm.value = mmH;
      }
    });

    // init
    clearAll();
  </script>
</body>
</html>
