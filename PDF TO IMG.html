<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>PDF → IMG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Roboto,system-ui,-apple-system,Arial; background:#eef2f7; color:#222; padding:2rem;}
    h2{color:#1e3a8a;margin-bottom:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:0.8rem;align-items:center}
    input[type=file]{padding:1rem;border:2px dashed #cbd5e1;border-radius:10px;background:#fff}
    select,input[type=number]{padding:0.7rem;border-radius:8px;border:1px solid #d1d5db}
    label{font-size:0.95rem}
    .status{margin-top:1.2rem;max-height:46vh;overflow:auto;background:#fff;padding:1rem;border-radius:10px;box-shadow:0 6px 18px rgba(30,58,138,0.06)}
    .status ul{list-style:none;padding:0;margin:0}
    .status li{padding:0.4rem 0;border-bottom:1px dashed #eee;font-size:0.95rem}
    .status .ok{color:#16a34a}
    .status .err{color:#dc2626}
    .form-row{display:flex;gap:0.6rem;align-items:center}
    .panel{display:flex;flex-direction:column;gap:0.6rem}
    .small{font-size:0.85rem;color:#475569}

    /* sticky bottom bar */
    .action-bar{position:sticky;bottom:0;left:0;right:0;background:#fff;padding:0.8rem;border-top:1px solid #e6eef9;box-shadow:0 -6px 18px rgba(30,58,138,0.04);display:flex;justify-content:space-between;align-items:center;margin-top:1rem}
    .action-bar .left{display:flex;gap:0.6rem}
    button{padding:0.7rem 1rem;border-radius:10px;border:none;background:#1e3a8a;color:#fff;font-weight:600;cursor:pointer}
    .btn-ghost{background:#fff;color:#1e3a8a;border:1px solid #cfe0ff}
    .btn-danger{background:#ef4444}
    .meta{font-size:0.9rem;color:#334155}

    @media(max-width:720px){.controls{flex-direction:column}.form-row{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <h2><i class="fa-solid fa-file-pdf"></i> PDF → IMG</h2>

  <div class="controls">
    <label>
      <input id="fileInput" type="file" accept="application/pdf" style="display:none">
      <div id="dropArea" style="padding:1rem 1.2rem;border-radius:10px;background:#fff;border:2px dashed #cbd5e1;cursor:pointer;min-width:260px;text-align:left">
        <div><strong>Pilih / Taruh file PDF</strong></div>
        <div class="small">Klik untuk pilih PDF (hanya 1 file diproses per aksi)</div>
      </div>
    </label>

    <div class="panel">
      <label class="small">Resolusi (dpi)</label>
      <select id="dpiSelect">
        <option value="300">300</option>
        <option value="400">400</option>
        <option value="500">500</option>
        <option value="800">800</option>
      </select>
    </div>

    <div class="panel">
      <label class="small">Mode Resize</label>
      <select id="modeResize">
        <option value="asli">Do Not Scale</option>
        <option value="fit">Fit</option>
        <option value="fill">Fill</option>
        <option value="stretch">Stretch</option>
      </select>
    </div>

    <div class="panel" style="min-width:220px">
		<div class="small">Ukuran halaman (mm)</div>
		<div class="form-row">
		<input id="widthMm" type="number" step="0.01" placeholder="Panjang (mm)" style="width:120px">
		<input id="heightMm" type="number" step="0.01" placeholder="Tinggi (mm)" style="width:120px">
	</div>
		<div class="small"><label><input id="useOriginalSize" type="checkbox" checked> Gunakan ukuran asli</label></div>
	</div>


    <div style="margin-left:auto;display:flex;flex-direction:column;gap:0.4rem;align-items:flex-end">
      <div class="meta" id="detectedSize">Belum ada file dipilih</div>
    </div>
  </div>

  <div class="status" id="statusBox">
    <ul id="statusList"></ul>
  </div>

  <div class="action-bar">
    <div class="left">
      <button id="resetBtn" class="btn-ghost">Reset</button>
    </div>
    <div style="display:flex;gap:0.6rem">
      <button id="convertBtn">Ubah & Unduh JPG</button>
    </div>
  </div>

  <canvas id="renderCanvas" style="display:none"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // Konfigurasi pdf.js
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const dropArea = document.getElementById('dropArea');
    const statusList = document.getElementById('statusList');
    const statusBox = document.getElementById('statusBox');
    const dpiSelect = document.getElementById('dpiSelect');
    const modeResize = document.getElementById('modeResize');
    const widthMm = document.getElementById('widthMm');
    const heightMm = document.getElementById('heightMm');
    const useOriginalSize = document.getElementById('useOriginalSize');
    const detectedSize = document.getElementById('detectedSize');
    const convertBtn = document.getElementById('convertBtn');
    const resetBtn = document.getElementById('resetBtn');
    const canvas = document.getElementById('renderCanvas');
    const ctx = canvas.getContext('2d');

    let loadedPdf = null;
    let loadedPdfName = '';
    let pageSizesPts = []; // array of {wPts,hPts}

    function updateStatus(text, ok = true){
      const li = document.createElement('li');
      li.innerHTML = ok ? `<span class="ok">✓</span> ${text}` : `<span class="err">✖</span> ${text}`;
      statusList.appendChild(li);
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    // Drag & drop & click
    dropArea.addEventListener('click',()=>fileInput.click());
    dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.style.borderColor='#94a3b8'});
    dropArea.addEventListener('dragleave',e=>{e.preventDefault();dropArea.style.borderColor='#cbd5e1'});
    dropArea.addEventListener('drop',e=>{e.preventDefault();dropArea.style.borderColor='#cbd5e1'; if(e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files; fileChanged();});
    fileInput.addEventListener('change',fileChanged);

    function clearAll(){
      fileInput.value = '';
      loadedPdf = null;
      loadedPdfName = '';
      pageSizesPts = [];
      detectedSize.textContent = 'Belum ada file dipilih';
      statusList.innerHTML = '';
      widthMm.value = '';
      heightMm.value = '';
      useOriginalSize.checked = true;
      dpiSelect.value = '300';
      modeResize.value = 'asli';
    }

    resetBtn.addEventListener('click',()=>{
      clearAll();
      updateStatus('Form di-reset (input & log dibersihkan)');
    });

    async function fileChanged(){
      statusList.innerHTML = '';
      const file = fileInput.files && fileInput.files[0];
      if(!file) return;
      if(file.type !== 'application/pdf'){ updateStatus('Bukan file PDF', false); return; }
      loadedPdfName = file.name.replace(/\.[^/.]+$/,'');
      updateStatus(`Membaca file: ${file.name}`);
      try{
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({data:arrayBuffer});
        const pdf = await loadingTask.promise;
        loadedPdf = pdf;
        pageSizesPts = [];
        // baca ukuran tiap halaman (gunakan page 1 untuk preview ukuran default)
        for(let i=1;i<=Math.min(pdf.numPages,10);i++){ // baca max 10 halaman untuk mendapat gambaran
          const pg = await pdf.getPage(i);
          const vp = pg.getViewport({scale:1});
          pageSizesPts.push({w:vp.width,h:vp.height});
          pg.cleanup();
        }
        // gunakan ukuran page 1 sebagai default asli
        const first = pageSizesPts[0];
        const widthInch = first.w/72; const heightInch = first.h/72;
        const mmW = (widthInch*25.4).toFixed(2); const mmH = (heightInch*25.4).toFixed(2);
        detectedSize.textContent = `Deteksi ukuran (halaman 1): ${mmW} × ${mmH} mm`;
        widthMm.value = mmW; heightMm.value = mmH;
        useOriginalSize.checked = true;
        updateStatus(`PDF dimuat: ${pdf.numPages} halaman`);
      }catch(err){
        console.error(err);
        updateStatus('Gagal membaca PDF', false);
      }
    }

    // Utility: convert mm to inches
    function mmToInch(mm){return mm/25.4}

    convertBtn.addEventListener('click',async()=>{
      if(!loadedPdf){ updateStatus('Belum ada PDF yang dimuat', false); return; }
      const dpi = Number(dpiSelect.value);
      const mode = modeResize.value;
      const useOrig = useOriginalSize.checked;
      const targetWmm = useOrig ? Number(widthMm.value) : Number(widthMm.value);
      const targetHmm = useOrig ? Number(heightMm.value) : Number(heightMm.value);
      if(!targetWmm || !targetHmm){ updateStatus('Masukkan ukuran halaman (mm) terlebih dahulu', false); return; }

      updateStatus(`Mulai konversi (${loadedPdf.numPages} halaman) pada ${dpi} dpi, mode: ${mode}`);

      for(let p=1;p<=loadedPdf.numPages;p++){
        try{
          const page = await loadedPdf.getPage(p);
          const vp1 = page.getViewport({scale:1});
          const origWpts = vp1.width; const origHpts = vp1.height; // pts (1pt = 1/72 inch)
          const origWinch = origWpts/72; const origHinch = origHpts/72;

          // target physical size (inch)
          const targWinch = (Number(targetWmm))/25.4;
          const targHinch = (Number(targetHmm))/25.4;
          // target pixel dims
          const targWpx = Math.round(targWinch * dpi);
          const targHpx = Math.round(targHinch * dpi);

          // compute scales to map pdf pts -> pixels
          const S_w = (targWpx) / (origWpts);
          const S_h = (targHpx) / (origHpts);

          let renderScale;
          if(mode === 'asli'){
            // respect aspect and map so both sides match; prefer uniform scale that makes both equal (should be same if target corresponds to original)
            renderScale = Math.min(S_w,S_h);
            // but to ensure exact match, we'll render at S_w and then adjust canvas height if necessary
            renderScale = S_w; // width-based to match naming; height should match if using original size
          }else if(mode === 'fit'){
            renderScale = Math.min(S_w,S_h);
          }else if(mode === 'fill'){
            renderScale = Math.max(S_w,S_h);
          }else if(mode === 'stretch'){
            // we'll render at S_w (width scale) and then stretch vertically when drawing to final canvas
            renderScale = S_w;
          }

          // render page to intermediate canvas
          const viewport = page.getViewport({scale: renderScale});
          canvas.width = Math.round(viewport.width);
          canvas.height = Math.round(viewport.height);
          // clear
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0,0,canvas.width,canvas.height);

          await page.render({canvasContext:ctx,viewport}).promise;

          // final canvas to match exact target pixels
          const finalCanvas = document.createElement('canvas');
          finalCanvas.width = targWpx;
          finalCanvas.height = targHpx;
          const fctx = finalCanvas.getContext('2d');
          fctx.fillStyle = '#ffffff';
          fctx.fillRect(0,0,finalCanvas.width,finalCanvas.height);

          if(mode === 'asli' || mode === 'fit'){
            // draw centered (if smaller than target, keep centered; if larger shouldn't happen for fit)
            const dx = Math.round((targWpx - canvas.width)/2);
            const dy = Math.round((targHpx - canvas.height)/2);
            fctx.drawImage(canvas, dx, dy, canvas.width, canvas.height);
          }else if(mode === 'fill'){
            // canvas may be larger in one dimension; crop center
            // find offset to draw so center aligns
            const sx = Math.max(0, Math.round((canvas.width - targWpx)/2));
            const sy = Math.max(0, Math.round((canvas.height - targHpx)/2));
            // draw cropped area
            fctx.drawImage(canvas, sx, sy, targWpx, targHpx, 0, 0, targWpx, targHpx);
          }else if(mode === 'stretch'){
            // scale to fill final canvas (non-uniform allowed)
            fctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, targWpx, targHpx);
          }

          // export JPEG
          const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.95);
          const link = document.createElement('a');
          link.href = dataUrl;
          link.download = `${loadedPdfName}-(${p}).jpg`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          updateStatus(`Halaman ${p} selesai: ${link.download}`);
          page.cleanup();
        }catch(err){
          console.error(err);
          updateStatus(`Gagal konversi halaman ${p}`, false);
        }
      }

      updateStatus('Konversi selesai');
    });

    // ketika checkbox useOriginalSize toggle -> disable/enable custom inputs
    useOriginalSize.addEventListener('change',()=>{
      const use = useOriginalSize.checked;
      widthMm.disabled = use; heightMm.disabled = use;
      if(use && pageSizesPts.length){
        const first = pageSizesPts[0];
        const mmW = ((first.w/72)*25.4).toFixed(2);
        const mmH = ((first.h/72)*25.4).toFixed(2);
        widthMm.value = mmW; heightMm.value = mmH;
      }
    });

    // init
    clearAll();
  </script>
</body>
</html>

