<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BOOKLET PREVIEW – GitHub Pages (Same‑Origin PDF.js)</title>
  <style>
    :root { --bg:#f3f6fb; --ink:#0f172a; --muted:#64748b; --brand:#1e40af; --card:#fff; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:10}
    .container{max-width:1100px;margin:0 auto;padding:14px 18px}
    h1{margin:0 0 8px;font-size:20px;color:var(--brand)}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .control{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;box-shadow:0 1px 1px rgba(0,0,0,.04)}
    label{font-size:12px;color:var(--muted)}
    input[type=file], select{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff;color:var(--ink)}
    main{max-width:1100px;margin:18px auto;padding:0 18px 24px}
    #info{font-size:13px;color:var(--muted);margin-bottom:10px}
    .sheet{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px;margin:14px 0;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    .sheet h3{margin:0 0 10px;font-size:14px;color:var(--muted);display:flex;justify-content:space-between}
    .spread{display:flex;gap:10px;justify-content:center;align-items:flex-start;flex-wrap:wrap}
    .pageWrap{position:relative;border:1px dashed #d1d5db;border-radius:12px;padding:8px;background:#fafafa}
    canvas{display:block;border-radius:8px;max-width:100%;height:auto}
    .badge{position:absolute;top:8px;left:8px;background:#111827;color:#fff;border-radius:999px;padding:3px 8px;font-size:11px;opacity:.9}
    .pagenum{position:absolute;bottom:8px;right:8px;background:#ffffffd0;color:#111827;border:1px solid #e5e7eb;border-radius:999px;padding:2px 7px;font-size:11px}
    .hint{font-size:12px;color:var(--muted)}
    .warning{color:#b45309;background:#fff7ed;border:1px solid #fed7aa;padding:6px 10px;border-radius:8px}
  </style>
  <!-- IMPORTANT: Load pdf.js from the same origin to avoid worker/CORS issues on GitHub Pages -->
  <script src="./pdfjs/pdf.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>BOOKLET PREVIEW – GitHub Pages</h1>
      <div class="controls">
        <div class="control">
          <label>PDF sumber</label>
          <input id="file" type="file" accept="application/pdf" />
        </div>
        <div class="control">
          <label>Mode</label>
          <select id="mode">
            <option value="print">Urutan Cetak (imposition)</option>
            <option value="read" selected>Urutan Baca (spread)</option>
          </select>
        </div>
      </div>
      <div id="warn" class="hint"></div>
    </div>
  </header>

  <main>
    <div id="info">Unggah PDF (1 halaman per page). Sistem otomatis menambah halaman putih di akhir agar total menjadi kelipatan 4.</div>
    <div id="sheets"></div>
  </main>

<script>
const elWarn = document.getElementById('warn');
function warn(msg){ elWarn.innerHTML = '<span class="warning">'+msg+'</span>'; }

if (!window.pdfjsLib){
  warn('Tidak menemukan ./pdfjs/pdf.min.js. Pastikan Anda menaruh file pdf.min.js & pdf.worker.min.js di folder /pdfjs pada repo GitHub Pages Anda.');
} else {
  pdfjsLib.GlobalWorkerOptions.workerSrc = './pdfjs/pdf.worker.min.js';
}

const elFile   = document.getElementById('file');
const elSheets = document.getElementById('sheets');
const elInfo   = document.getElementById('info');
const elMode   = document.getElementById('mode');

let pdfDoc = null;
let srcPageCount = 0;
let totalForBooklet = 0;

elMode.addEventListener('change', () => { if (pdfDoc) buildAll(true); });

elFile.addEventListener('change', async (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  if (!window.pdfjsLib){ warn('pdf.js belum terpasang di /pdfjs'); return; }
  try {
    const buf = await f.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
    srcPageCount = pdfDoc.numPages;
    totalForBooklet = Math.ceil(srcPageCount / 4) * 4;
    elInfo.innerHTML = `Halaman sumber: <b>${srcPageCount}</b>. Dipadatkan ke kelipatan 4: <b>${totalForBooklet}</b> (tambah putih jika perlu).`;
    buildAll(true);
  } catch (err) {
    warn('Gagal membuka PDF: ' + (err && err.message ? err.message : err));
    console.error(err);
  }
});

function buildAll(resetCache){
  if (resetCache) window._renderCache = new Map();
  const mode = elMode.value;
  const sheets = [];
  if (mode === 'print') {
    const sheetCount = totalForBooklet / 4;
    for (let i = 0; i < sheetCount; i++) {
      const frontLeft  = totalForBooklet - (2*i);
      const frontRight = 1 + (2*i);
      const backLeft   = 2 + (2*i);
      const backRight  = totalForBooklet - 1 - (2*i);
      sheets.push({ side: 'FRONT', pair: [frontLeft, frontRight] });
      sheets.push({ side: 'BACK',  pair: [backLeft,  backRight]  });
    }
  } else {
    for (let p = 1; p <= totalForBooklet; p += 2) {
      sheets.push({ side: 'SPREAD', pair: [p, p+1] });
    }
  }

  elSheets.innerHTML = '';
  let sheetNo = 0;
  for (const sh of sheets) {
    sheetNo++;
    const wrap = document.createElement('section');
    wrap.className = 'sheet';
    const h3 = document.createElement('h3');
    h3.innerHTML = `<span>${mode==='print' ? \`Lembar \${Math.ceil(sheetNo/2)} – \${sh.side}\` : sh.side}</span>`+
                   `<span class="hint">Hal: ${fmtPage(sh.pair[0])} &nbsp;|&nbsp; ${fmtPage(sh.pair[1])}</span>`;
    wrap.appendChild(h3);

    const spread = document.createElement('div');
    spread.className = 'spread';

    spread.appendChild(makePageCell(sh.pair[0], 'KIRI'));
    spread.appendChild(makePageCell(sh.pair[1], 'KANAN'));

    wrap.appendChild(spread);
    elSheets.appendChild(wrap);
  }
}

function makePageCell(pageNum, sideText){
  const cell = document.createElement('div');
  cell.className = 'pageWrap';
  const badge = document.createElement('div'); badge.className='badge'; badge.textContent = sideText;
  const pn = document.createElement('div'); pn.className='pagenum'; pn.textContent = labelFor(pageNum);
  cell.appendChild(badge);
  cell.appendChild(pn);
  getPageCanvas(pageNum).then(c => cell.insertBefore(c, pn));
  return cell;
}

function fmtPage(n){ if (n<1 || n>srcPageCount) return `BLANK (${n})`; return `p.${n}`; }
function labelFor(n){ return fmtPage(n); }

async function getPageCanvas(pageNum){
  const key = `k${pageNum}`;
  if (!window._renderCache) window._renderCache = new Map();
  const cache = window._renderCache;
  if (cache.has(key)) return cloneCanvas(cache.get(key));

  if (pageNum<1 || pageNum>srcPageCount) {
    const blank = document.createElement('canvas');
    const w = 595, h = 842; blank.width = w; blank.height = h;
    const ctx = blank.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle = '#e5e7eb'; ctx.strokeRect(0.5,0.5,w-1,h-1);
    cache.set(key, blank); return cloneCanvas(blank);
  }

  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1 });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  canvas.width = Math.ceil(viewport.width);
  canvas.height = Math.ceil(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  cache.set(key, canvas);
  return cloneCanvas(canvas);
}
function cloneCanvas(src){
  const c = document.createElement('canvas');
  c.width = src.width; c.height = src.height;
  c.getContext('2d').drawImage(src, 0, 0);
  return c;
}
</script>
</body>
</html>
