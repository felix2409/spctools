<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flipbook Preview — tanpa mode</title>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--ink:#e5f0ff;--muted:#9fb0c7;--ring:#60a5fa;--accent:#22d3ee}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:radial-gradient(1000px 700px at 5% -5%, #0ea5e9 0, transparent 50%),linear-gradient(180deg,#0b1220,#0b1220 40%,#0a0f1c);color:var(--ink)}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(2,6,23,.8),rgba(2,6,23,.35) 70%,transparent);backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.18)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
    h1{margin:0;font-size:22px;font-weight:800;background:linear-gradient(90deg,#60a5fa,#22d3ee);-webkit-background-clip:text;background-clip:text;color:transparent}
    .bar{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .chip{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,rgba(148,163,184,.12),rgba(148,163,184,.06));border:1px solid rgba(148,163,184,.22);border-radius:14px;padding:10px 12px}
    label{font-size:12px;color:var(--muted)}
    input[type=file]{color:var(--ink);background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:10px;padding:8px 10px}
    main{max-width:1200px;margin:18px auto;padding:0 18px 40px}
    .stage{position:relative;background:linear-gradient(180deg,rgba(148,163,184,.10),rgba(148,163,184,.06));border:1px solid rgba(148,163,184,.20);border-radius:18px;box-shadow:0 12px 50px rgba(2,6,23,.5);padding:16px;overflow:hidden}
    .viewport{position:relative;width:100%;padding-bottom:66%;border-radius:12px;background:#0a0f1c;box-shadow:inset 0 0 0 1px rgba(148,163,184,.12)}
    .spread{position:absolute;inset:0;display:flex;gap:10px;justify-content:center;align-items:center;padding:10px}
    .page{position:relative;border:1px dashed rgba(148,163,184,.35);border-radius:10px;background:#0b1220;padding:8px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    canvas{display:block;max-width:100%;height:auto;border-radius:6px}
    .num{position:absolute;bottom:8px;right:8px;background:#020617b0;border:1px solid rgba(148,163,184,.35);color:#e2e8f0;border-radius:999px;padding:2px 7px;font-size:11px}
    /* arrows */
    .nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;user-select:none}
    .btn:hover{border-color:var(--ring)}
    .info{font-size:12px;color:var(--muted)}
    .thumbs{display:flex;gap:8px;overflow:auto;margin-top:10px;padding-bottom:4px}
    .th{position:relative;border:1px dashed rgba(148,163,184,.35);border-radius:8px;padding:4px;background:#0b1220;cursor:pointer}
    .th .num{position:absolute;top:4px;left:4px;right:auto}
    .active{outline:2px solid var(--accent)}
    .fade-enter{animation:fade .28s ease-out}
    @keyframes fade{from{opacity:.2; transform:translateY(4px)}to{opacity:1; transform:none}}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Flipbook Preview</h1>
    <div class="bar">
      <div class="chip"><label>PDF sumber</label><input id="file" type="file" accept="application/pdf"></div>
      <div id="status" class="info">Cover muncul di kanan, lalu pasangan 2–3, 4–5, dst. Jika ganjil, ditambah putih di akhir.</div>
    </div>
  </div>
</header>

<main>
  <section class="stage">
    <div class="viewport">
      <div id="spread" class="spread"></div>
    </div>
    <div class="nav">
      <div class="btn" id="prev">⟵ Sebelumnya</div>
      <div class="info" id="meta">—</div>
      <div class="btn" id="next">Berikutnya ⟶</div>
    </div>
    <div id="thumbs" class="thumbs"></div>
  </section>
</main>

<script>
// Worker setup: prefer CDN, fallback ./pdfjs
if (window.pdfjsLib) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js';
} else {
  const s=document.createElement('script'); s.src='./pdfjs/pdf.min.js';
  s.onload=()=>{ pdfjsLib.GlobalWorkerOptions.workerSrc='./pdfjs/pdf.worker.min.js'; };
  document.head.appendChild(s);
}

const elFile=document.getElementById('file');
const elSpread=document.getElementById('spread');
const elMeta=document.getElementById('meta');
const elThumbs=document.getElementById('thumbs');
const elPrev=document.getElementById('prev');
const elNext=document.getElementById('next');
const elStatus=document.getElementById('status');

let pdfDoc=null, srcPages=0, total=0;
let viewIndex=0; // 0: cover (page 1 alone), then 1: pages(2,3), 2: (4,5), ...

elFile.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const buf=await f.arrayBuffer();
    pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;
    srcPages=pdfDoc.numPages;
    total = (srcPages % 2 === 0) ? srcPages : srcPages + 1; // genap
    viewIndex=0;
    buildThumbs();
    renderSpread(true);
  }catch(err){
    elStatus.textContent='Gagal membuka PDF.';
    console.error(err);
  }
});

function spreadPagesAt(idx){
  // idx=0 => cover only (right). After that, pairs (2,3), (4,5),...
  if (idx===0) return [null, 1]; // left blank, right page 1
  const left = 2*idx;
  const right= 2*idx+1;
  return [left<=total?left:null, right<=total?right:null];
}

async function renderSpread(scrollTop){
  if(!pdfDoc) return;
  const [L,R]=spreadPagesAt(viewIndex);
  elSpread.innerHTML='';
  const wrapL=document.createElement('div'); wrapL.className='page fade-enter';
  const wrapR=document.createElement('div'); wrapR.className='page fade-enter';
  if(L){ const c=await pageCanvas(L); wrapL.appendChild(c); const n=badge(`p.${L}`); wrapL.appendChild(n); } else { wrapL.appendChild(blankCanvas()); wrapL.appendChild(badge('BLANK')); }
  if(R){ const c=await pageCanvas(R); wrapR.appendChild(c); const n=badge(`p.${R}`); wrapR.appendChild(n); } else { wrapR.appendChild(blankCanvas()); wrapR.appendChild(badge('BLANK')); }
  elSpread.appendChild(wrapL); elSpread.appendChild(wrapR);
  elMeta.textContent = (L?`p.${L}`:'BLANK') + ' | ' + (R?`p.${R}`:'BLANK');
  highlightThumb(L||R);
  if(scrollTop){ window.scrollTo({top:0,behavior:'smooth'}); }
}

function badge(t){ const b=document.createElement('div'); b.className='num'; b.textContent=t; return b; }

async function buildThumbs(){
  elThumbs.innerHTML='';
  const limit=Math.min(srcPages, 30);
  for(let p=1;p<=limit;p++){
    const t=document.createElement('div'); t.className='th';
    const c=await pageCanvas(p, 0.18);
    const n=badge(p); n.style.top='4px'; n.style.left='4px'; n.style.right='auto';
    t.appendChild(n); t.appendChild(c); elThumbs.appendChild(t);
    t.addEventListener('click', ()=>{
      // go to the spread that contains this page
      if(p===1) viewIndex=0; else viewIndex = Math.ceil((p-1)/2);
      renderSpread(true);
    });
  }
}

elPrev.addEventListener('click', ()=>{ if(viewIndex>0){viewIndex--; renderSpread(false);} });
elNext.addEventListener('click', ()=>{ const maxIndex=Math.ceil(total/2)-1; if(viewIndex<maxIndex){viewIndex++; renderSpread(false);} });
document.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') elPrev.click(); if(e.key==='ArrowRight') elNext.click(); });

function highlightThumb(page){
  Array.from(elThumbs.children).forEach(x=>x.classList.remove('active'));
  if(!page) return;
  const idx=Math.min(page-1, elThumbs.children.length-1);
  if(idx>=0) elThumbs.children[idx].classList.add('active');
}

async function pageCanvas(p, scaleOverride){
  const key='p'+p+'@'+(scaleOverride||1);
  if(!window._cache) window._cache=new Map();
  const cache=window._cache;
  if(cache.has(key)) return clone(cache.get(key));
  // blank if beyond src range
  if(p<1 || p>srcPages){ const c=blankCanvas(); cache.set(key,c); return clone(c); }
  const page=await pdfDoc.getPage(p);
  const v=page.getViewport({scale: scaleOverride || 1});
  const c=document.createElement('canvas'); c.width=v.width; c.height=v.height;
  await page.render({canvasContext:c.getContext('2d',{alpha:false}), viewport:v}).promise;
  cache.set(key,c); return clone(c);
}
function blankCanvas(){ const c=document.createElement('canvas'); c.width=595; c.height=842; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle='rgba(148,163,184,.5)'; ctx.strokeRect(.5,.5,c.width-1,c.height-1); return c; }
function clone(src){ const c=document.createElement('canvas'); c.width=src.width; c.height=src.height; c.getContext('2d').drawImage(src,0,0); return c; }
</script>
</body>
</html>
