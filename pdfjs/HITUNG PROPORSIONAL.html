<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flipbook Preview — Local PDF.js (Diagnostics)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:#0b1220;color:#e5f0ff}
    header{position:sticky;top:0;z-index:20;background:#0f172a;border-bottom:1px solid #1e293b}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
    h1{margin:0 0 6px;font-weight:800;font-size:20px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:flex;align-items:center;gap:10px;background:#0b1220;border:1px solid #1e293b;border-radius:12px;padding:8px 12px}
    label{font-size:12px;color:#9fb0c7}
    input[type=file]{color:#e5f0ff;background:#0b1220;border:1px solid #334155;border-radius:10px;padding:8px 10px}
    .diag{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0a0f1c;border:1px solid #1e293b;border-radius:10px;padding:10px;margin-top:10px}
    main{max-width:1200px;margin:16px auto;padding:0 18px 40px}
    .stage{background:#0a0f1c;border:1px solid #1e293b;border-radius:16px;padding:14px}
    .viewport{position:relative;width:100%;padding-bottom:62%;background:#0b1220;border-radius:10px;border:1px dashed #334155}
    .spread{position:absolute;inset:0;display:flex;gap:10px;justify-content:center;align-items:center;padding:10px}
    .page{position:relative;border:1px dashed #334155;border-radius:10px;background:#0b1220;padding:8px}
    canvas{display:block;max-width:100%;height:auto;border-radius:6px}
    .num{position:absolute;bottom:8px;right:8px;background:#020617b0;border:1px solid #334155;color:#e2e8f0;border-radius:999px;padding:2px 7px;font-size:11px}
  </style>
  <script src="./pdfjs/pdf.min.js"></script>
  <script>
    window._diag = [];
    function log(msg){ _diag.push(msg); document.getElementById('diag').textContent = _diag.join('\n'); }
    (function(){
      if (!window.pdfjsLib) {
        document.addEventListener('DOMContentLoaded', ()=>log('❌ pdfjsLib TIDAK ditemukan di ./pdfjs/pdf.min.js'));
      } else {
        document.addEventListener('DOMContentLoaded', ()=>{
          log('✅ pdf.min.js ditemukan.');
          try {
            pdfjsLib.GlobalWorkerOptions.workerSrc = './pdfjs/pdf.worker.min.js';
            log('➡️  workerSrc diset ke ./pdfjs/pdf.worker.min.js');
          } catch (e) {
            log('❌ Gagal set workerSrc: '+ e.message);
          }
        });
      }
    })();
  </script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Flipbook Preview — Local Only</h1>
    <div class="bar">
      <div class="chip"><label>PDF sumber</label><input id="file" type="file" accept="application/pdf"></div>
      <div id="status" class="chip" style="color:#9fb0c7">Gunakan PDF halaman tunggal per page. Jika ganjil, putih akan ditambah otomatis.</div>
    </div>
    <div id="diag" class="diag"></div>
  </div>
</header>
<main>
  <div class="stage">
    <div class="viewport"><div id="spread" class="spread"></div></div>
  </div>
</main>

<script>
const elFile=document.getElementById('file');
const elSpread=document.getElementById('spread');
const elStatus=document.getElementById('status');
function log(msg){ _diag.push(msg); document.getElementById('diag').textContent = _diag.join('\n'); }

let pdfDoc=null, srcPages=0, total=0, viewIndex=0;
elFile.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  if (!window.pdfjsLib){ elStatus.textContent='pdf.js tidak tersedia — pastikan file ada di /pdfjs/'; return; }
  try{
    const buf=await f.arrayBuffer();
    pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;
    srcPages=pdfDoc.numPages; total=(srcPages%2===0)?srcPages:srcPages+1; viewIndex=0;
    log('✅ PDF terbuka. Halaman sumber: '+srcPages+' → total genap: '+total);
    render();
  }catch(err){
    elStatus.textContent='Gagal membuka PDF (lihat diagnostics di atas).';
    log('❌ Error getDocument: '+ (err && err.message ? err.message : err));
    console.error(err);
  }
});

function pagesAt(i){ if(i===0) return [null,1]; const L=2*i, R=2*i+1; return [L<=total?L:null, R<=total?R:null]; }
async function render(){
  const [L,R]=pagesAt(viewIndex); elSpread.innerHTML='';
  elSpread.appendChild(await pageBox(L)); elSpread.appendChild(await pageBox(R));
}
async function pageBox(n){
  const box=document.createElement('div'); box.className='page';
  if(!n || n>srcPages){ box.appendChild(blank()); box.appendChild(tag('BLANK')); return box; }
  const c=await canvasFor(n); box.appendChild(c); box.appendChild(tag('p.'+n)); return box;
}
function tag(t){ const d=document.createElement('div'); d.className='num'; d.textContent=t; return d; }
function blank(){ const c=document.createElement('canvas'); c.width=595; c.height=842; const g=c.getContext('2d'); g.fillStyle='#fff'; g.fillRect(0,0,c.width,c.height); g.strokeStyle='#334155'; g.strokeRect(.5,.5,c.width-1,c.height-1); return c; }
async function canvasFor(p){
  const page=await pdfDoc.getPage(p); const v=page.getViewport({scale:1}); const c=document.createElement('canvas'); c.width=v.width; c.height=v.height;
  await page.render({canvasContext:c.getContext('2d',{alpha:false}),viewport:v}).promise; return c;
}
</script>
</body>
</html>
